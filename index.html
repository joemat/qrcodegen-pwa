<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>QR Code Generator</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="images/152.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="white" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="QR Code Gen">
  <meta name="msapplication-TileImage" content="images/144.png">
  <meta name="msapplication-TileColor" content="#FFFFFF">
</head>

<body class="fullscreen">
  
  <div class="container">
    <h2 class="title">QR Code Generator</h2>
    <h3>Text to encode</h3>
    <textarea id="fileContent" name="textarea" rows="20" cols="40" oninput="updateQrCode()">https://joemat.github.io/qrcodegen-pwa/</textarea>
    <br /><input id="loadFileDialog" type="file" oninput="loadFile(event)" name="Load file ..." />
    <br />
    <a id="imgDownloadLink" target="_blank"><div id="qrcode" class="qrCode"></div></a>
    <div id="downloadLinkDiv"></div>
    <div id="footer">
      <br />
      <hr>
      <h3>Content specs:</h3>
      <ul>
        <li><a href="https://en.wikipedia.org/wiki/EPC_QR_code">Payments</a></li>
        <li><a href="https://en.wikipedia.org/wiki/VCard">vcard</a></li>
        <li><a href="https://en.wikipedia.org/wiki/QR_code#Joining_a_Wi%E2%80%91Fi_network">Wi-Fi Network</a></li>
      </ul>
      <hr/>
      <h3>Code based on:</h3>
      <ul>
        <li><a href="https://github.com/jamesjohnson280/hello-pwa">hello-pwa</a> (<a href="lib/LICENSE">MIT License</a>)
        </li>
        <li><a href="https://davidshimjs.github.io/qrcodejs/">QRCode.js</a> (<a href="lib/qrcode.js/LICENSE">MIT
            License</a>)</li>
      </ul>
    </div>

    <script src="lib/qrcode.js/qrcode.js"></script>
    <script>
      var qrcode = undefined;
      updateQrCode(); // show initial qrcode

      function loadFile(event) {
        const filename = event.target.files[0];

        const reader = new FileReader();
        reader.addEventListener('load', (event) => {
          text = event.target.result;
          document.getElementById('fileContent').value = text;
          updateQrCode();
        });
        reader.readAsText(filename)
      }

      function updateQrCode() {

        if (qrcode != undefined) {
          qrcode.clear();
          document.getElementById("qrcode").textContent = ""
        }
        textToEncode = document.getElementById('fileContent').value;
        qrCodeDiv = document.getElementById("qrcode");
        qrcode = new QRCode(qrCodeDiv, {
          text: textToEncode
        });
        registerImageObserver();
      }

      function registerImageObserver() {
        imagesSelector = document.querySelector("img");
        observer = new MutationObserver(() => {
              updateDownloadUrl()});
              observer.observe(imagesSelector, { 
          attributes: true,
          attributeList: [ 'src']
        });
      }

      function updateDownloadUrl() {
        qrCodeImage = document.querySelector("div.qrCode > img");        
        downloadLink = document.createElement("a");
        downloadLink.setAttribute('href', qrCodeImage.getAttribute('src'));
        downloadLink.text = "Download";
        downloadLink.download = "qrcode.png";
        document.getElementById("downloadLinkDiv").replaceChildren(downloadLink)
        document.getElementById("imgDownloadLink").setAttribute('href', qrCodeImage.getAttribute('src'));
      }
    </script>
  </div>
  <script src="js/main.js"></script>
</body>

</html>